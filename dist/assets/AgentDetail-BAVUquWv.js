import{r as e,c as t,h as a,aB as n,aw as l,n as s,S as r,j as o,y as i,z as c,P as u,I as d,ag as m,aq as p,G as v,H as f,ax as _,L as h,M as y,A as g,u as b,J as x}from"./vendor-wniUkaaU.js";import{i as w}from"./echarts-DqFpOE5C.js";import{a as k}from"./index-0kTfrp-L.js";import{a as A,w as L}from"./element-plus-BmMKkfCB.js";import{_ as S}from"./_plugin-vue_export-helper-BCo6x5W8.js";const F={class:"agent-detail"},I={class:"card-header"},C={key:0,class:"metric-content"},D={class:"metric-info"},N={class:"metric-value"},z={key:1,class:"metric-content offline"},M={key:0,class:"metric-content"},P={class:"metric-info"},B={class:"metric-value"},E={key:1,class:"metric-content offline"},U={key:0,class:"metric-content"},j={class:"metric-info"},$={class:"metric-value"},O={key:1,class:"metric-content offline"},V={class:"card-header"},H={key:0,class:"offline-message"},T=S({__name:"AgentDetail",setup(S){const T=n(),K=_(),G=l(),W=e(!1),q=e({}),J=e([]),R=e(604800),Y=e("cpu"),Q=e({}),X=e(null),Z=e(null),ee=e(null),te=e(null),ae=e(null),ne=e(null),le=e(null),se=e(null),re=t((()=>{if(!(J.value&&J.value.length&&q.value&&q.value.is_online))return{cpu_usage:0,memory_percent:0,disk_percent:0,load_average:{load1:0,load5:0,load15:0},process_count:0,network_info:{bytes_sent:0,bytes_recv:0,tcp_connections:0,udp_connections:0}};const e=J.value[0],t=(e,t)=>{if(!e)return 0;const a=t.split(".");let n=e;for(const s of a){if(null==n)return 0;n=n[s]}const l=parseFloat(n);return isNaN(l)?0:Number(l.toFixed(1))};let a=t(e,"cpu_usage");0===a&&(a=t(e,"cpu_percent"));let n=t(e,"memory_info.percent");0===n&&(n=t(e,"memory_percent"));let l=t(e,"disk_info.percent");0===l&&(l=t(e,"disk_percent"));const s=e.load_average||{load1:e.load1||0,load5:e.load5||0,load15:e.load15||0},r=e.network_info||{bytes_sent:e.bytes_sent||0,bytes_recv:e.bytes_recv||0,tcp_connections:e.tcp_connections||0,udp_connections:e.udp_connections||0};return{cpu_usage:a,memory_percent:n,disk_percent:l,load_average:s,process_count:e.process_count||0,network_info:r}})),oe=e=>e>=90?"exception":e>=70?"warning":"success",ie=e=>e.getFullYear()+"-"+(e.getMonth()+1).toString().padStart(2,"0")+"-"+e.getDate().toString().padStart(2,"0")+" "+e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0")+":"+e.getSeconds().toString().padStart(2,"0"),ce=e=>{if(!e)return"未知";"string"==typeof e&&(e=new Date(e));const t=Math.floor((new Date-e)/1e3);let a=t/31536e3;return a>1?Math.floor(a)+" 年前":(a=t/2592e3,a>1?Math.floor(a)+" 个月前":(a=t/86400,a>1?Math.floor(a)+" 天前":(a=t/3600,a>1?Math.floor(a)+" 小时前":(a=t/60,a>1?Math.floor(a)+" 分钟前":Math.floor(t)+" 秒前"))))},ue=()=>{K.push("/")},de=async()=>{try{let e=T.params.id;if(e.startsWith("{")&&e.endsWith("}")){e=e.substring(1,e.length-1);const t=`/agent/${e}`;K.replace(t)}const t=G.getters.agents.find((t=>t.id===e));if(t)q.value=t;else{const t=await k.getAgent(e);t&&t.data&&(t.data.data?q.value=t.data.data:q.value=t.data)}if(!q.value||!q.value.id)throw new Error("无法获取有效的代理信息");q.value.is_online||void 0===q.value.isOnline||(q.value.is_online=q.value.isOnline)}catch(e){q.value={},A.error("获取代理详情失败: "+e.message)}},me=async()=>{try{if(!q.value||!q.value.id)return;if(!q.value.is_online)return void(J.value=[]);let e=q.value.id;const t=Math.floor(Date.now()/1e3),a=t-R.value,n=604800===R.value?300:86400===R.value?150:100,l=await k.getAgentMetrics(e,{from:a,to:t,limit:n});if(l){let e=[];if(Array.isArray(l)?e=l:Array.isArray(l.data)?e=l.data:l.data&&l.data.data&&Array.isArray(l.data.data)&&(e=l.data.data),J.value=e,e.length>0&&q.value.is_online){const e={name:Y.value};he(e)}}else J.value=[]}catch(e){J.value=[],A.error("获取指标数据失败: "+e.message)}},pe=()=>{Object.entries(Q.value).forEach((([e,t])=>{t&&(t._resizeListener&&window.removeEventListener("resize",t._resizeListener),t.dispose())})),Q.value={}},ve=e=>{if(!e||e.length<2)return[];const t=[];for(let a=1;a<e.length;a++){const n=e[a],l=e[a-1],s=(n[0]-l[0])/1e3;if(s<=0)continue;const r=n[1]-l[1];if(r<0)continue;const o=r/s/1024;t.push([n[0],o])}return t},fe=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":e<1073741824?(e/1048576).toFixed(2)+" MB":(e/1073741824).toFixed(2)+" GB",_e=(e,t)=>{0!==t.clientWidth&&0!==t.clientHeight||(t.style.width="100%",t.style.height="400px",t.offsetHeight);const a=w(t,null,{renderer:"canvas",useDirtyRect:!1});if(Q.value[t.id]=a,a.showLoading({text:"加载数据中...",maskColor:"rgba(255, 255, 255, 0.8)",fontSize:16}),J.value&&J.value.length>0)try{ye(e,a,J.value),a.hideLoading(),setTimeout((()=>{a.resize({width:"auto",height:"auto"})}),100)}catch(l){a.hideLoading()}else a.hideLoading(),a.setOption({title:{text:"没有数据可显示",left:"center",top:"center",textStyle:{fontSize:20,color:"#999"}}});const n=()=>{a.resize()};return window.addEventListener("resize",n),a._resizeListener=n,a},he=e=>{var t;const a=(null==(t=e.props)?void 0:t.name)||e.paneName||e.name;a&&(pe(),Y.value=a,s((()=>{const e={cpu:Z,memory:ee,disk:te,load:ae,process:ne,network:le,connections:se}[Y.value].value;e&&_e(Y.value,e)})))},ye=(e,t,a)=>{if(!t||!a||a.length<2)return;const n=[...a].sort(((e,t)=>e.timestamp-t.timestamp));let l="";3600===R.value?l="过去1小时":86400===R.value?l="过去1天":604800===R.value&&(l="过去7天");const s={type:"time",splitLine:{show:!1},axisPointer:{show:!0},axisLine:{show:!0},axisTick:{show:!0},boundaryGap:!1,min:function(e){return e.min===e.max?e.min-36e5:e.min},max:function(e){return e.min===e.max?e.max+36e5:e.max},axisLabel:{formatter:function(e){const t=new Date(e);return t.getMonth()+1+"/"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()},interval:"auto",rotate:0}};let r;if("cpu"===e){r={title:{text:`CPU使用率 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);return ie(t)+"<br />CPU使用率: "+e[0].value[1].toFixed(2)+"%"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:s,yAxis:{type:"value",min:0,max:100,axisLabel:{formatter:"{value}%"}},series:[{name:"CPU使用率",data:n.map((e=>{const t=parseFloat(e.cpu_usage||e.cpu_percent||0);return[1e3*e.timestamp,t]})),type:"line",smooth:!0,showSymbol:!1,areaStyle:{}}]}}else if("memory"===e){r={title:{text:`内存使用率 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);return ie(t)+"<br />内存使用率: "+e[0].value[1].toFixed(2)+"%"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:s,yAxis:{type:"value",min:0,max:100,axisLabel:{formatter:"{value}%"}},series:[{name:"内存使用率",data:n.map((e=>{let t=0;return e.memory_info&&e.memory_info.percent?t=parseFloat(e.memory_info.percent):e.memory_percent&&(t=parseFloat(e.memory_percent)),[1e3*e.timestamp,t]})),type:"line",smooth:!0,showSymbol:!1,areaStyle:{}}]}}else if("disk"===e){r={title:{text:`磁盘使用率 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);return ie(t)+"<br />磁盘使用率: "+e[0].value[1].toFixed(2)+"%"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:s,yAxis:{type:"value",min:0,max:100,axisLabel:{formatter:"{value}%"}},series:[{name:"磁盘使用率",data:n.map((e=>{let t=0;return e.disk_info&&e.disk_info.percent?t=parseFloat(e.disk_info.percent):e.disk_percent&&(t=parseFloat(e.disk_percent)),[1e3*e.timestamp,t]})),type:"line",smooth:!0,showSymbol:!1,areaStyle:{}}]}}else if("load"===e){r={title:{text:`系统负载 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);let a=ie(t)+"<br />";return e.forEach((e=>{a+=e.seriesName+": "+e.value[1].toFixed(2)+"<br />"})),a}},grid:{left:"3%",right:"4%",bottom:"10%",containLabel:!0},legend:{data:["1分钟","5分钟","15分钟"],bottom:0},xAxis:s,yAxis:{type:"value"},series:[{name:"1分钟",data:n.map((e=>{let t=0;return e.load_average&&e.load_average.load1?t=parseFloat(e.load_average.load1):e.load1&&(t=parseFloat(e.load1)),[1e3*e.timestamp,t]})),type:"line",smooth:!0},{name:"5分钟",data:n.map((e=>{let t=0;return e.load_average&&e.load_average.load5?t=parseFloat(e.load_average.load5):e.load5&&(t=parseFloat(e.load5)),[1e3*e.timestamp,t]})),type:"line",smooth:!0},{name:"15分钟",data:n.map((e=>{let t=0;return e.load_average&&e.load_average.load15?t=parseFloat(e.load_average.load15):e.load15&&(t=parseFloat(e.load15)),[1e3*e.timestamp,t]})),type:"line",smooth:!0}]}}else if("process"===e){r={title:{text:`进程数 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);return ie(t)+"<br />进程数: "+e[0].value[1]}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:s,yAxis:{type:"value",minInterval:1},series:[{name:"进程数",data:n.map((e=>[1e3*e.timestamp,parseInt(e.process_count||0)])),type:"line",smooth:!0,showSymbol:!1,areaStyle:{}}]}}else if("network"===e){const e=n.map((e=>{let t=0;return e.network_info&&e.network_info.bytes_sent?t=parseInt(e.network_info.bytes_sent):e.bytes_sent&&(t=parseInt(e.bytes_sent)),[1e3*e.timestamp,t]})),t=n.map((e=>{let t=0;return e.network_info&&e.network_info.bytes_recv?t=parseInt(e.network_info.bytes_recv):e.bytes_recv&&(t=parseInt(e.bytes_recv)),[1e3*e.timestamp,t]}));r={title:{text:`网络流量 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);let a=ie(t)+"<br />";return e.forEach((e=>{const t=e.value[1],n=e.seriesIndex<2?fe(t):(t/1024).toFixed(2)+" KB/s";a+=e.seriesName+": "+n+"<br />"})),a}},grid:{left:"3%",right:"4%",bottom:"10%",containLabel:!0},legend:{data:["发送总量","接收总量","发送速率","接收速率"],bottom:0},xAxis:s,yAxis:[{type:"value",name:"流量总量",axisLabel:{formatter:function(e){return fe(e)}}},{type:"value",name:"速率 (KB/s)",axisLabel:{formatter:"{value} KB/s"}}],series:[{name:"发送总量",data:e,type:"line",smooth:!0,yAxisIndex:0},{name:"接收总量",data:t,type:"line",smooth:!0,yAxisIndex:0},{name:"发送速率",data:ve(e),type:"line",smooth:!0,yAxisIndex:1},{name:"接收速率",data:ve(t),type:"line",smooth:!0,yAxisIndex:1}]}}else if("connections"===e){r={title:{text:`网络连接数 (${l})`,left:"center"},tooltip:{trigger:"axis",formatter:function(e){const t=new Date(e[0].value[0]);let a=ie(t)+"<br />";return e.forEach((e=>{a+=e.seriesName+": "+e.value[1]+"<br />"})),a}},grid:{left:"3%",right:"4%",bottom:"10%",containLabel:!0},legend:{data:["TCP连接数","UDP连接数"],bottom:0},xAxis:s,yAxis:{type:"value",minInterval:1},series:[{name:"TCP连接数",data:n.map((e=>{const t=1e3*e.timestamp;let a=0;return e.network_info&&void 0!==e.network_info.tcp_connections?a=parseInt(e.network_info.tcp_connections):void 0!==e.tcp_connections&&(a=parseInt(e.tcp_connections)),isNaN(a)&&(a=0),[t,a]})),type:"line",smooth:!0,showSymbol:!1,areaStyle:{}},{name:"UDP连接数",data:n.map((e=>{const t=1e3*e.timestamp;let a=0;return e.network_info&&void 0!==e.network_info.udp_connections?a=parseInt(e.network_info.udp_connections):void 0!==e.udp_connections&&(a=parseInt(e.udp_connections)),isNaN(a)&&(a=0),[t,a]})),type:"line",smooth:!0,showSymbol:!1,areaStyle:{}}]}}r&&t.setOption(r,!0)};a((async()=>{W.value=!0;try{if(window.addEventListener("resize",ge),await G.dispatch("fetchAgents"),await de(),!q.value||!q.value.id)return void(W.value=!1);await me(),s((()=>{if(q.value.is_online&&J.value.length>0){const e=Z.value;e&&_e("cpu",e)}})),X.value=setInterval((async()=>{await G.dispatch("fetchAgents"),await de(),q.value&&q.value.is_online&&(await me(),s((()=>{const e={cpu:Z,memory:ee,disk:te,load:ae,process:ne,network:le,connections:se}[Y.value].value;e&&(pe(),_e(Y.value,e))})))}),3e4)}catch(e){A.error("初始化错误: "+e.message)}finally{W.value=!1}})),r((()=>{X.value&&(clearInterval(X.value),X.value=null),window.removeEventListener("resize",ge),pe()}));const ge=()=>{be(Y.value,!1)},be=(e,t=!1)=>{const a={cpu:Z,memory:ee,disk:te,load:ae,process:ne,network:le,connections:se}[e];if(a&&a.value){const n=a.value,l=Q.value[n.id];if(l&&!t)l.resize();else if(t){he({name:e})}}};return o(Y,((e,t)=>{if(t&&e&&e!==t&&0===Object.keys(Q.value).length){he({name:e})}})),o(R,((e,t)=>{e!==t&&(pe(),me().then((()=>{s((()=>{const e={cpu:Z,memory:ee,disk:te,load:ae,process:ne,network:le,connections:se}[Y.value].value;e&&_e(Y.value,e)}))})).catch((e=>{A.error("获取数据失败: "+e.message)})))})),(e,t)=>{const a=m("el-page-header"),n=m("el-tag"),l=m("el-descriptions-item"),s=m("el-descriptions"),r=m("el-card"),o=m("el-progress"),_=m("el-icon"),w=m("el-col"),k=m("el-row"),A=m("el-radio-button"),S=m("el-radio-group"),T=m("el-alert"),K=m("el-tab-pane"),G=m("el-tabs"),J=p("loading");return c(),i("div",F,[u(a,{onBack:ue,title:"返回仪表盘"}),d((c(),v(r,{class:"agent-info-card"},{header:f((()=>[g("div",I,[g("span",null,y(q.value.name||q.value.hostname),1),u(n,{type:q.value.is_online?"success":"danger"},{default:f((()=>[h(y(q.value.is_online?"在线":"离线"),1)])),_:1},8,["type"])])])),default:f((()=>[u(s,{column:2,border:""},{default:f((()=>[u(l,{label:"主机名"},{default:f((()=>[h(y(q.value.hostname),1)])),_:1}),u(l,{label:"平台"},{default:f((()=>[h(y(q.value.platform),1)])),_:1}),u(l,{label:"IP地址"},{default:f((()=>[h(y(q.value.ip_address),1)])),_:1}),u(l,{label:"最后在线"},{default:f((()=>[h(y(ce(q.value.last_seen)),1)])),_:1}),u(l,{label:"创建时间"},{default:f((()=>[h(y(ie(q.value.created_at)),1)])),_:1})])),_:1})])),_:1})),[[J,W.value]]),u(k,{gutter:20,class:"metrics-row"},{default:f((()=>[u(w,{span:8},{default:f((()=>[u(r,{class:"metric-card"},{header:f((()=>t[2]||(t[2]=[g("div",{class:"card-header"},[g("span",null,"CPU使用率")],-1)]))),default:f((()=>{return[q.value.is_online?(c(),i("div",C,[u(o,{type:"dashboard",percentage:Number(re.value.cpu_usage),status:(e=Number(re.value.cpu_usage),e>=90?"exception":e>=70?"warning":"success")},null,8,["percentage","status"]),g("div",D,[g("div",N,y(re.value.cpu_usage)+"%",1),t[3]||(t[3]=g("div",{class:"metric-label"},"当前使用率",-1))])])):(c(),i("div",z,[u(_,{size:"48"},{default:f((()=>[u(b(L))])),_:1}),t[4]||(t[4]=g("div",{class:"metric-info"},[g("div",{class:"metric-value"},"离线"),g("div",{class:"metric-label"},"无法获取数据")],-1))]))];var e})),_:1})])),_:1}),u(w,{span:8},{default:f((()=>[u(r,{class:"metric-card"},{header:f((()=>t[5]||(t[5]=[g("div",{class:"card-header"},[g("span",null,"内存使用率")],-1)]))),default:f((()=>[q.value.is_online?(c(),i("div",M,[u(o,{type:"dashboard",percentage:Number(re.value.memory_percent),status:oe(Number(re.value.memory_percent))},null,8,["percentage","status"]),g("div",P,[g("div",B,y(re.value.memory_percent)+"%",1),t[6]||(t[6]=g("div",{class:"metric-label"},"当前使用率",-1))])])):(c(),i("div",E,[u(_,{size:"48"},{default:f((()=>[u(b(L))])),_:1}),t[7]||(t[7]=g("div",{class:"metric-info"},[g("div",{class:"metric-value"},"离线"),g("div",{class:"metric-label"},"无法获取数据")],-1))]))])),_:1})])),_:1}),u(w,{span:8},{default:f((()=>[u(r,{class:"metric-card"},{header:f((()=>t[8]||(t[8]=[g("div",{class:"card-header"},[g("span",null,"磁盘使用率")],-1)]))),default:f((()=>[q.value.is_online?(c(),i("div",U,[u(o,{type:"dashboard",percentage:Number(re.value.disk_percent),status:oe(Number(re.value.disk_percent))},null,8,["percentage","status"]),g("div",j,[g("div",$,y(re.value.disk_percent)+"%",1),t[9]||(t[9]=g("div",{class:"metric-label"},"当前使用率",-1))])])):(c(),i("div",O,[u(_,{size:"48"},{default:f((()=>[u(b(L))])),_:1}),t[10]||(t[10]=g("div",{class:"metric-info"},[g("div",{class:"metric-value"},"离线"),g("div",{class:"metric-label"},"无法获取数据")],-1))]))])),_:1})])),_:1})])),_:1}),u(r,{class:"chart-card"},{header:f((()=>[g("div",V,[t[14]||(t[14]=g("span",null,"历史数据",-1)),u(S,{modelValue:R.value,"onUpdate:modelValue":t[0]||(t[0]=e=>R.value=e),onChange:me,disabled:!q.value.is_online},{default:f((()=>[u(A,{label:3600},{default:f((()=>t[11]||(t[11]=[h("1小时")]))),_:1}),u(A,{label:86400},{default:f((()=>t[12]||(t[12]=[h("1天")]))),_:1}),u(A,{label:604800},{default:f((()=>t[13]||(t[13]=[h("1周")]))),_:1})])),_:1},8,["modelValue","disabled"])])])),default:f((()=>[q.value.is_online?x("",!0):(c(),i("div",H,[u(T,{title:"代理当前离线",type:"warning",description:"该代理当前处于离线状态，无法获取实时监控数据。当代理重新上线后，图表将自动更新。","show-icon":"",closable:!1})])),u(G,{modelValue:Y.value,"onUpdate:modelValue":t[1]||(t[1]=e=>Y.value=e),disabled:!q.value.is_online,onTabClick:he},{default:f((()=>[u(K,{label:"CPU",name:"cpu"},{default:f((()=>[g("div",{id:"cpu-chart",ref_key:"cpuChart",ref:Z,class:"chart"},null,512)])),_:1}),u(K,{label:"内存",name:"memory"},{default:f((()=>[g("div",{id:"memory-chart",ref_key:"memoryChart",ref:ee,class:"chart"},null,512)])),_:1}),u(K,{label:"磁盘",name:"disk"},{default:f((()=>[g("div",{id:"disk-chart",ref_key:"diskChart",ref:te,class:"chart"},null,512)])),_:1}),u(K,{label:"负载",name:"load"},{default:f((()=>[g("div",{id:"load-chart",ref_key:"loadChart",ref:ae,class:"chart"},null,512)])),_:1}),u(K,{label:"进程数",name:"process"},{default:f((()=>[g("div",{id:"process-chart",ref_key:"processChart",ref:ne,class:"chart"},null,512)])),_:1}),u(K,{label:"网络流量",name:"network"},{default:f((()=>[g("div",{id:"network-chart",ref_key:"networkChart",ref:le,class:"chart"},null,512)])),_:1}),u(K,{label:"网络连接",name:"connections"},{default:f((()=>[g("div",{id:"connections-chart",ref_key:"connectionsChart",ref:se,class:"chart"},null,512)])),_:1})])),_:1},8,["modelValue","disabled"])])),_:1})])}}},[["__scopeId","data-v-ef32261a"]]);export{T as default};
