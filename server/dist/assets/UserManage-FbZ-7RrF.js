import{r as e,c as a,aw as r,h as l,y as s,z as t,P as o,H as u,ag as d,ax as n,aq as i,I as m,G as p,L as c,M as f,A as v,u as w}from"./vendor-wniUkaaU.js";import{b as g}from"./index-0kTfrp-L.js";import{a as h,p as _,f as b}from"./element-plus-BmMKkfCB.js";import{_ as y}from"./_plugin-vue_export-helper-BCo6x5W8.js";const V=g.create({baseURL:"/api",headers:{"Content-Type":"application/json"}});V.interceptors.request.use((e=>{const a=localStorage.getItem("token");return a&&(e.headers.Authorization=`Bearer ${a}`),e}),(e=>Promise.reject(e))),V.interceptors.response.use((e=>e),(e=>{if(e.response){const a=e.response.status,r=e.response.data;let l=r.error||"未知错误",s=r.detail||"";h.error(s?`${l}: ${s}`:l),401===a&&(localStorage.removeItem("token"),window.location.href="/login")}else e.request?h.error("网络错误：服务器未响应"):h.error(`请求错误：${e.message}`);return Promise.reject(e)}));const U={getUsers:()=>V.get("/admin/users").then((e=>e.data)),createUser:e=>V.post("/admin/users",e).then((e=>e.data)),deleteUser:e=>V.delete(`/admin/users/${e}`).then((e=>e.data)),getCurrentUser:()=>V.get("/users/me").then((e=>e.data)),updatePassword:e=>V.put("/users/password",e).then((e=>e.data))},x={class:"user-manage-container"},P={class:"card-header"},k={class:"header-left"},C={class:"dialog-footer"},j=y({__name:"UserManage",setup(g){const y=r(),V=n(),j=e(!1),q=e(!1),A=e(!1),L=e([]),$=e(null),T=e({username:"",password:"",confirmPassword:"",role:"user"}),I=a((()=>y.state.user||{})),z={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应为3-20个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:5,max:30,message:"密码长度应为5-30个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入密码",trigger:"blur"},{validator:(e,a,r)=>{a!==T.value.password?r(new Error("两次输入的密码不一致")):r()},trigger:"blur"}]},B=e=>e?new Date(1e3*e).toLocaleString():"未知",S=()=>{V.push("/")},M=async()=>{var e,a;j.value=!0;try{const e=await U.getUsers();L.value=e||[]}catch(r){h.error("获取用户列表失败: "+((null==(a=null==(e=r.response)?void 0:e.data)?void 0:a.error)||r.message))}finally{j.value=!1}},R=async()=>{$.value&&await $.value.validate((async e=>{var a,r;if(e){q.value=!0;try{const e={username:T.value.username,password:T.value.password,role:T.value.role},a=await U.createUser(e);h.success("添加用户成功"),A.value=!1,T.value={username:"",password:"",confirmPassword:"",role:"user"},await new Promise((e=>setTimeout(e,500)));const r={username:a.username,role:a.role,lastLogin:null,createdAt:a.createdAt};L.value=[r,...L.value],setTimeout((()=>{M()}),1e3)}catch(l){h.error((null==(r=null==(a=l.response)?void 0:a.data)?void 0:r.error)||"添加用户失败")}finally{q.value=!1}}}))},D=async e=>{var a,r;try{await U.deleteUser(e),h.success("删除用户成功"),M()}catch(l){h.error((null==(r=null==(a=l.response)?void 0:a.data)?void 0:r.error)||"删除用户失败")}};return l((()=>{M()})),(e,a)=>{const r=d("el-button"),l=d("el-icon"),n=d("el-table-column"),g=d("el-tag"),y=d("el-table"),V=d("el-card"),U=d("el-input"),M=d("el-form-item"),E=d("el-radio"),G=d("el-radio-group"),H=d("el-form"),F=d("el-dialog"),J=i("loading");return t(),s("div",x,[o(V,null,{header:u((()=>[v("div",P,[v("div",k,[o(r,{icon:"ArrowLeft",onClick:S},{default:u((()=>a[7]||(a[7]=[c("返回")]))),_:1}),a[8]||(a[8]=v("span",{class:"title"},"用户管理",-1))]),o(r,{type:"primary",onClick:a[0]||(a[0]=e=>A.value=!0)},{default:u((()=>[o(l,null,{default:u((()=>[o(w(_))])),_:1}),a[9]||(a[9]=c(" 添加用户 "))])),_:1})])])),default:u((()=>[m((t(),p(y,{data:L.value,style:{width:"100%"}},{default:u((()=>[o(n,{prop:"username",label:"用户名","min-width":"120"}),o(n,{prop:"role",label:"角色","min-width":"100"},{default:u((({row:e})=>[o(g,{type:"admin"===e.role?"danger":"info"},{default:u((()=>[c(f("admin"===e.role?"管理员":"普通用户"),1)])),_:2},1032,["type"])])),_:1}),o(n,{label:"最后登录时间","min-width":"160"},{default:u((({row:e})=>[c(f(B(e.lastLogin)),1)])),_:1}),o(n,{label:"创建时间","min-width":"160"},{default:u((({row:e})=>[c(f(B(e.createdAt)),1)])),_:1}),o(n,{label:"操作",width:"250",fixed:"right"},{default:u((({row:e})=>[o(r,{type:"danger",size:"small",onClick:a=>{var r;"admin"!==(r=e).username?r.username!==I.value.username?b.confirm(`确定要删除用户 ${r.username} 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}).then((()=>{D(r.username)})).catch((()=>{})):h.warning("不能删除当前登录的账户"):h.warning("不能删除管理员账户")},disabled:"admin"===e.username||e.username===I.value.username},{default:u((()=>a[10]||(a[10]=[c(" 删除 ")]))),_:2},1032,["onClick","disabled"])])),_:1})])),_:1},8,["data"])),[[J,j.value]])])),_:1}),o(F,{modelValue:A.value,"onUpdate:modelValue":a[6]||(a[6]=e=>A.value=e),title:"添加用户",width:"500px"},{footer:u((()=>[v("div",C,[o(r,{onClick:a[5]||(a[5]=e=>A.value=!1)},{default:u((()=>a[13]||(a[13]=[c("取消")]))),_:1}),o(r,{type:"primary",onClick:R,loading:q.value},{default:u((()=>a[14]||(a[14]=[c(" 确认 ")]))),_:1},8,["loading"])])])),default:u((()=>[o(H,{model:T.value,rules:z,ref_key:"formRef",ref:$,"label-width":"100px"},{default:u((()=>[o(M,{label:"用户名",prop:"username"},{default:u((()=>[o(U,{modelValue:T.value.username,"onUpdate:modelValue":a[1]||(a[1]=e=>T.value.username=e),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),o(M,{label:"密码",prop:"password"},{default:u((()=>[o(U,{modelValue:T.value.password,"onUpdate:modelValue":a[2]||(a[2]=e=>T.value.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1}),o(M,{label:"确认密码",prop:"confirmPassword"},{default:u((()=>[o(U,{modelValue:T.value.confirmPassword,"onUpdate:modelValue":a[3]||(a[3]=e=>T.value.confirmPassword=e),type:"password",placeholder:"请再次输入密码","show-password":""},null,8,["modelValue"])])),_:1}),o(M,{label:"角色"},{default:u((()=>[o(G,{modelValue:T.value.role,"onUpdate:modelValue":a[4]||(a[4]=e=>T.value.role=e)},{default:u((()=>[o(E,{label:"user"},{default:u((()=>a[11]||(a[11]=[c("普通用户")]))),_:1}),o(E,{label:"admin"},{default:u((()=>a[12]||(a[12]=[c("管理员")]))),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-4ad6e624"]]);export{j as default};
