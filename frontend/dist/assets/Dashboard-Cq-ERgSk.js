import{r as e,c as a,aw as t,h as l,S as s,y as r,z as n,A as d,P as o,H as i,ag as u,ax as c,aq as p,L as v,M as f,u as h,G as m,J as _,I as g}from"./vendor-wniUkaaU.js";import{c as w,d as y,e as b,r as k}from"./element-plus-BmMKkfCB.js";import{a as M}from"./index-0kTfrp-L.js";import{_ as x}from"./_plugin-vue_export-helper-BCo6x5W8.js";const C={class:"dashboard-container"},F={class:"dashboard-header"},D={class:"user-menu"},I={class:"el-dropdown-link"},A={class:"card-content"},j={class:"stat-value"},z={class:"card-content"},P={class:"stat-value success"},U={class:"card-content"},q={class:"stat-value danger"},G={class:"card-header"},H={class:"server-name"},J=x({__name:"Dashboard",setup(x){const J=c(),L=t(),N=e(!0),S=e(!1),T=e(null),$=e({}),B=a((()=>L.getters.agents)),E=a((()=>B.value.length)),K=a((()=>B.value.filter((e=>e.is_online)).length)),O=a((()=>B.value.filter((e=>!e.is_online)).length)),Q=a((()=>L.state.user||{})),R=a((()=>Q.value&&"admin"===Q.value.role)),V=e=>{switch(e){case"users":J.push("/users");break;case"logout":L.dispatch("logout"),J.push("/login")}},W=async()=>{const e=B.value.filter((e=>e.is_online));for(const t of e)try{const e=Math.floor(Date.now()/1e3),a={from:e-300,to:e,limit:1},l=await M.getAgentMetrics(t.id,a);l&&l.length>0&&($.value[t.id]=l[0])}catch(a){}},X=(e,a)=>{var t,l;const s=$.value[e];if(!s)return 0;switch(a){case"cpu_usage":return parseFloat(s.cpu_usage||0).toFixed(1);case"memory_percent":return parseFloat((null==(t=s.memory_info)?void 0:t.percent)||0).toFixed(1);case"disk_percent":return parseFloat((null==(l=s.disk_info)?void 0:l.percent)||0).toFixed(1);default:return 0}},Y=e=>{const a=parseFloat(e);return a>=90?"exception":a>=70?"warning":"success"},Z=async()=>{S.value=!0;try{await L.dispatch("fetchAgents"),await W()}catch(e){}finally{S.value=!1}},ee=e=>{if(!e)return"未知";"string"==typeof e&&(e=new Date(e));const a=Math.floor((new Date-e)/1e3);let t=a/31536e3;return t>1?Math.floor(t)+" 年前":(t=a/2592e3,t>1?Math.floor(t)+" 个月前":(t=a/86400,t>1?Math.floor(t)+" 天前":(t=a/3600,t>1?Math.floor(t)+" 小时前":(t=a/60,t>1?Math.floor(t)+" 分钟前":Math.floor(a)+" 秒前"))))};return l((()=>{(async()=>{N.value=!0;try{await L.dispatch("fetchAgents"),await W()}catch(e){}finally{N.value=!1}})(),T.value=setInterval(Z,6e4)})),s((()=>{T.value&&clearInterval(T.value)})),(e,a)=>{const t=u("el-avatar"),l=u("el-icon"),s=u("el-dropdown-item"),c=u("el-dropdown-menu"),M=u("el-dropdown"),x=u("el-card"),L=u("el-col"),T=u("el-row"),$=u("el-button"),W=u("el-table-column"),ae=u("el-progress"),te=u("el-table"),le=p("loading");return n(),r("div",C,[d("div",F,[a[2]||(a[2]=d("div",{class:"logo"},[d("h2",null,"系统监控平台")],-1)),d("div",D,[o(M,{trigger:"click",onCommand:V},{dropdown:i((()=>[o(c,null,{default:i((()=>[R.value?(n(),m(s,{key:0,command:"users"},{default:i((()=>a[0]||(a[0]=[v("用户管理")]))),_:1})):_("",!0),o(s,{command:"logout"},{default:i((()=>a[1]||(a[1]=[v("退出登录")]))),_:1})])),_:1})])),default:i((()=>[d("span",I,[o(t,{size:32,icon:"User"}),v(" "+f(Q.value.username||"未登录")+" ",1),o(l,null,{default:i((()=>[o(h(w))])),_:1})])])),_:1})])]),o(T,{gutter:20},{default:i((()=>[o(L,{span:8},{default:i((()=>[o(x,{class:"overview-card"},{header:i((()=>a[3]||(a[3]=[d("div",{class:"card-header"},[d("span",null,"总服务器")],-1)]))),default:i((()=>[d("div",A,[d("div",j,f(E.value),1),a[4]||(a[4]=d("div",{class:"stat-label"},"已连接服务器",-1))])])),_:1})])),_:1}),o(L,{span:8},{default:i((()=>[o(x,{class:"overview-card"},{header:i((()=>a[5]||(a[5]=[d("div",{class:"card-header"},[d("span",null,"在线服务器")],-1)]))),default:i((()=>[d("div",z,[d("div",P,f(K.value),1),a[6]||(a[6]=d("div",{class:"stat-label"},"正常运行",-1))])])),_:1})])),_:1}),o(L,{span:8},{default:i((()=>[o(x,{class:"overview-card"},{header:i((()=>a[7]||(a[7]=[d("div",{class:"card-header"},[d("span",null,"离线服务器")],-1)]))),default:i((()=>[d("div",U,[d("div",q,f(O.value),1),a[8]||(a[8]=d("div",{class:"stat-label"},"未响应",-1))])])),_:1})])),_:1})])),_:1}),o(T,{gutter:20,class:"server-list"},{default:i((()=>[o(L,{span:24},{default:i((()=>[o(x,null,{header:i((()=>[d("div",G,[a[10]||(a[10]=d("span",null,"服务器列表",-1)),o($,{type:"primary",onClick:Z,loading:S.value},{default:i((()=>[o(l,null,{default:i((()=>[o(h(k))])),_:1}),a[9]||(a[9]=v(" 刷新 "))])),_:1},8,["loading"])])])),default:i((()=>[g((n(),m(te,{data:B.value,style:{width:"100%"}},{default:i((()=>[o(W,{prop:"name",label:"服务器名称","min-width":"180"},{default:i((e=>[d("div",H,[e.row.is_online?(n(),m(l,{key:0,style:{color:"#67C23A"}},{default:i((()=>[o(h(y))])),_:1})):(n(),m(l,{key:1,style:{color:"#F56C6C"}},{default:i((()=>[o(h(b))])),_:1})),d("span",null,f(e.row.name||e.row.hostname),1)])])),_:1}),o(W,{prop:"hostname",label:"主机名","min-width":"150"}),o(W,{prop:"platform",label:"平台","min-width":"120"}),o(W,{prop:"ip_address",label:"IP地址","min-width":"130"}),o(W,{prop:"last_seen",label:"最后在线","min-width":"160"},{default:i((e=>[v(f(ee(e.row.last_seen)),1)])),_:1}),o(W,{prop:"created_at",label:"创建时间","min-width":"160"},{default:i((e=>{return[v(f((a=e.row.created_at,a?("string"==typeof a&&(a=new Date(a)),new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(a)):"未知")),1)];var a})),_:1}),o(W,{label:"CPU使用率","min-width":"120"},{default:i((({row:e})=>[o(ae,{percentage:X(e.id,"cpu_usage"),status:Y(X(e.id,"cpu_usage")),"stroke-width":10},null,8,["percentage","status"])])),_:1}),o(W,{label:"内存使用率","min-width":"120"},{default:i((({row:e})=>[o(ae,{percentage:X(e.id,"memory_percent"),status:Y(X(e.id,"memory_percent")),"stroke-width":10},null,8,["percentage","status"])])),_:1}),o(W,{label:"磁盘使用率","min-width":"120"},{default:i((({row:e})=>[o(ae,{percentage:X(e.id,"disk_percent"),status:Y(X(e.id,"disk_percent")),"stroke-width":10},null,8,["percentage","status"])])),_:1}),o(W,{label:"操作",width:"120",fixed:"right"},{default:i((({row:e})=>[o($,{type:"primary",size:"small",onClick:a=>{return t=e.id,void J.push(`/agent/${t}`);var t}},{default:i((()=>a[11]||(a[11]=[v(" 详情 ")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[le,N.value]])])),_:1})])),_:1})])),_:1})])}}},[["__scopeId","data-v-0999dc7e"]]);export{J as default};
